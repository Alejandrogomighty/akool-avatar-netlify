<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akool Streaming Avatar</title>
    <!-- 1. Include Agora Web SDK (ensure this is the correct/latest version recommended by Akool/Agora) -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #avatar-container {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #000;
        }
        #logs { 
            margin-top: 20px; 
            padding: 10px; 
            border: 1px solid #eee; 
            background-color: #fff; 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 0.9em; 
        }
        .log-entry { margin-bottom: 5px; }
        .log-error { color: red; }
    </style>
</head>
<body>
    <h1>Akool Streaming Avatar</h1>
    <p>Welcome! Your avatar should appear below and greet you shortly.</p>

    <!-- 2. Container for the avatar -->
    <div id="avatar-container"></div>

    <div id="status-messages"></div>
    <div id="logs"><strong>Logs:</strong><br></div>

    <script>
        const AKOOL_AVATAR_ID = "dvp_Tristan_cloth2_1080P"; // User provided Avatar ID
        let akoolSessionId = null;
        let agoraClient = null;
        let remoteUser = null;

        const logContainer = document.getElementById("logs");
        const statusContainer = document.getElementById("status-messages");

        function addLog(message, isError = false) {
            console.log(message);
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry";
            if (isError) {
                logEntry.classList.add("log-error");
                console.error(message);
            }
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${typeof message === "object" ? JSON.stringify(message) : message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function setStatus(message) {
            addLog(message);
            statusContainer.textContent = message;
        }

        async function createAvatarSession() {
            setStatus("Creating avatar session...");
            try {
                const response = await fetch("/.netlify/functions/create-avatar-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ avatar_id: AKOOL_AVATAR_ID })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(`Failed to create session: ${data.error || response.statusText}`);
                }
                addLog("Avatar session created successfully.");
                addLog(data); 
                akoolSessionId = data.data._id; // Assuming _id is the session_id from Akool API response
                return data.data.credentials; // Assuming credentials are in data.data.credentials
            } catch (error) {
                addLog(`Error creating avatar session: ${error.message}`, true);
                setStatus(`Error: Could not create avatar session. ${error.message}`);
                return null;
            }
        }

        async function initializeAgora(credentials) {
            if (!credentials || !credentials.agora_app_id || !credentials.agora_token || !credentials.agora_channel || !credentials.agora_uid) {
                addLog("Agora credentials missing or incomplete.", true);
                setStatus("Error: Agora credentials missing.");
                return false;
            }
            setStatus("Initializing Agora...");
            agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

            try {
                const uid = await agoraClient.join(credentials.agora_app_id, credentials.agora_channel, credentials.agora_token, credentials.agora_uid);
                addLog(`Successfully joined Agora channel with UID: ${uid}`);
                setStatus("Avatar connected. Waiting for stream...");

                agoraClient.on("user-published", async (user, mediaType) => {
                    addLog(`Remote user ${user.uid} published: ${mediaType}`);
                    await agoraClient.subscribe(user, mediaType);
                    if (mediaType === "video") {
                        remoteUser = user;
                        const remoteVideoTrack = user.videoTrack;
                        const playerContainer = document.getElementById("avatar-container");
                        playerContainer.innerHTML = ""; // Clear previous content
                        remoteVideoTrack.play(playerContainer);
                        addLog("Avatar video stream playing.");
                        setStatus("Avatar is live!");
                        // Now that avatar is streaming, make it speak
                        triggerGreeting(); 
                    }
                    if (mediaType === "audio") {
                        const remoteAudioTrack = user.audioTrack;
                        remoteAudioTrack.play();
                        addLog("Avatar audio stream playing.");
                    }
                });

                agoraClient.on("user-unpublished", (user, mediaType) => {
                    addLog(`Remote user ${user.uid} unpublished: ${mediaType}`);
                    if (remoteUser && remoteUser.uid === user.uid && mediaType === "video") {
                        document.getElementById("avatar-container").innerHTML = "Stream ended.";
                        setStatus("Avatar stream ended.");
                    }
                });
                return true;
            } catch (error) {
                addLog(`Agora join/subscribe error: ${error.message}`, true);
                setStatus(`Error: Could not connect to Agora. ${error.message}`);
                return false;
            }
        }

        async function pushMessageToAvatar(text) {
            if (!akoolSessionId) {
                addLog("Cannot push message: Akool session ID is missing.", true);
                return;
            }
            setStatus(`Sending greeting: "${text}"`);
            try {
                const response = await fetch("/.netlify/functions/push-avatar-message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ session_id: akoolSessionId, text: text, type: "text", interrupt: false })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(`Failed to push message: ${data.error || response.statusText}`);
                }
                addLog("Message pushed to avatar successfully.");
                setStatus("Greeting sent to avatar.");
            } catch (error) {
                addLog(`Error pushing message to avatar: ${error.message}`, true);
                setStatus(`Error: Could not send greeting. ${error.message}`);
            }
        }

        function triggerGreeting() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get("name");
            const email = urlParams.get("email"); // Email and message are not used in greeting for now, but available
            const message = urlParams.get("message");

            let greetingText = "Hello there! Welcome.";
            if (name) {
                greetingText = `Hello, ${name}! Welcome.`;
            }
            // You can customize the greeting further using email or message if needed.
            // For now, we will use the name for the greeting.
            // The original request was to pass name, email and message to the avatar, and greet by name.
            // The `message` from the form could be spoken after the initial greeting if desired.
            // For example: pushMessageToAvatar(`I received your message: ${message}`);
            
            addLog(`Preparing to greet user: ${name || "guest"}`)
            pushMessageToAvatar(greetingText);
        }

        async function main() {
            addLog("Page loaded. Starting avatar integration.");
            const agoraCredentials = await createAvatarSession();
            if (agoraCredentials) {
                await initializeAgora(agoraCredentials);
                // Greeting is now triggered after video stream starts in initializeAgora
            } else {
                setStatus("Failed to initialize avatar. Please check logs.");
            }
        }

        window.onload = main;

        // Optional: Clean up Agora connection on page unload
        window.onbeforeunload = async () => {
            if (agoraClient) {
                await agoraClient.leave();
                addLog("Left Agora channel.");
            }
        };

    </script>
</body>
</html>
