<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akool Streaming Avatar</title>
    <!-- 1. Include Agora Web SDK (ensure this is the correct/latest version recommended by Akool/Agora) -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #avatar-container {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background-color: #000;
        }
        #logs { 
            margin-top: 20px; 
            padding: 10px; 
            border: 1px solid #eee; 
            background-color: #fff; 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 0.9em; 
        }
        .log-entry { margin-bottom: 5px; word-break: break-all; }
        .log-error { color: red; }
        #status-messages { margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Akool Streaming Avatar</h1>
    <p>Welcome! Your avatar should appear below and greet you shortly.</p>

    <!-- 2. Container for the avatar -->
    <div id="avatar-container"></div>

    <div id="status-messages">Attempting to load avatar...</div>
    <div id="logs"><strong>Logs:</strong><br></div>

    <script>
        const AKOOL_AVATAR_ID = "dvp_Tristan_cloth2_1080P"; // User provided Avatar ID
        let akoolSessionId = null;
        let agoraClient = null;
        let remoteUser = null;

        const logContainer = document.getElementById("logs");
        const statusContainer = document.getElementById("status-messages");

        function addLog(message, isError = false) {
            const messageString = (typeof message === "object") ? JSON.stringify(message) : message;
            console.log(messageString);
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry";
            if (isError) {
                logEntry.classList.add("log-error");
                console.error(messageString);
            }
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${messageString}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function setStatus(message, isError = false) {
            addLog(message, isError);
            statusContainer.textContent = message;
            if(isError) statusContainer.style.color = "red";
            else statusContainer.style.color = "#333";
        }

        async function createAvatarSession() {
            setStatus("Creating avatar session...");
            try {
                const response = await fetch("/.netlify/functions/create-avatar-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ avatar_id: AKOOL_AVATAR_ID })
                });
                const data = await response.json();
                
                addLog("Raw response from /create-avatar-session:");
                addLog(data);

                if (!response.ok) { // Checks if HTTP status is 2xx from Netlify function
                    throw new Error(`Netlify function error (HTTP ${response.status}): ${data.error || data.msg || response.statusText || "Unknown error from function"}`);
                }

                // Akool specific success check (code 1000)
                if (data.code !== 1000) {
                    throw new Error(`Akool API Error (code ${data.code}): ${data.msg || "Unknown Akool API error"}`);
                }

                if (!data.data || !data.data._id || !data.data.credentials) {
                    throw new Error("Akool API response missing expected data structure (session ID or credentials).");
                }

                addLog("Avatar session created successfully via Akool API.");
                akoolSessionId = data.data._id;
                return data.data.credentials;

            } catch (error) {
                setStatus(`Error: Could not create avatar session. ${error.message}`, true);
                return null;
            }
        }

        async function initializeAgora(credentials) {
            if (!credentials || !credentials.agora_app_id || !credentials.agora_token || !credentials.agora_channel || !credentials.agora_uid) {
                setStatus("Error: Agora credentials missing or incomplete.", true);
                return false;
            }
            setStatus("Initializing Agora...");
            agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

            try {
                const uid = await agoraClient.join(credentials.agora_app_id, credentials.agora_channel, credentials.agora_token, credentials.agora_uid);
                addLog(`Successfully joined Agora channel with UID: ${uid}`);
                setStatus("Avatar connected. Waiting for stream...");

                agoraClient.on("user-published", async (user, mediaType) => {
                    addLog(`Remote user ${user.uid} published: ${mediaType}`);
                    await agoraClient.subscribe(user, mediaType);
                    if (mediaType === "video") {
                        remoteUser = user;
                        const remoteVideoTrack = user.videoTrack;
                        const playerContainer = document.getElementById("avatar-container");
                        playerContainer.innerHTML = ""; // Clear previous content
                        remoteVideoTrack.play(playerContainer);
                        addLog("Avatar video stream playing.");
                        setStatus("Avatar is live!");
                        triggerGreeting(); 
                    }
                    if (mediaType === "audio") {
                        const remoteAudioTrack = user.audioTrack;
                        remoteAudioTrack.play();
                        addLog("Avatar audio stream playing.");
                    }
                });

                agoraClient.on("user-unpublished", (user, mediaType) => {
                    addLog(`Remote user ${user.uid} unpublished: ${mediaType}`);
                    if (remoteUser && remoteUser.uid === user.uid && mediaType === "video") {
                        document.getElementById("avatar-container").innerHTML = "Stream ended.";
                        setStatus("Avatar stream ended.");
                    }
                });
                return true;
            } catch (error) {
                setStatus(`Error: Could not connect to Agora. ${error.message}`, true);
                return false;
            }
        }

        async function pushMessageToAvatar(text) {
            if (!akoolSessionId) {
                addLog("Cannot push message: Akool session ID is missing.", true);
                return;
            }
            setStatus(`Sending greeting: "${text}"`);
            try {
                const response = await fetch("/.netlify/functions/push-avatar-message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ session_id: akoolSessionId, text: text, type: "text", interrupt: false })
                });
                const data = await response.json();
                addLog("Raw response from /push-avatar-message:");
                addLog(data);

                if (!response.ok) {
                    throw new Error(`Netlify function error (HTTP ${response.status}): ${data.error || data.msg || response.statusText || "Unknown error from function"}`);
                }
                if (data.code !== 1000) {
                     throw new Error(`Akool API Error (code ${data.code}): ${data.msg || "Unknown Akool API error when pushing message"}`);
                }
                addLog("Message pushed to avatar successfully.");
                setStatus("Greeting sent to avatar.");
            } catch (error) {
                setStatus(`Error: Could not send greeting. ${error.message}`, true);
            }
        }

        function triggerGreeting() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get("name");
            
            let greetingText = "Hello there! Welcome.";
            if (name) {
                greetingText = `Hello, ${name}! Welcome.`;
            }
            
            addLog(`Preparing to greet user: ${name || "guest"}`);
            pushMessageToAvatar(greetingText);
        }

        async function main() {
            addLog("Page loaded. Starting avatar integration.");
            const agoraCredentials = await createAvatarSession();
            if (agoraCredentials) {
                await initializeAgora(agoraCredentials);
            } else {
                // Status already set by createAvatarSession on failure
                addLog("Avatar initialization failed because session creation or credential retrieval failed.", true);
            }
        }

        window.onload = main;

        window.onbeforeunload = async () => {
            if (agoraClient) {
                try {
                    await agoraClient.leave();
                    addLog("Left Agora channel.");
                } catch (e) {
                    addLog("Error leaving Agora channel: " + e.message, true);
                }
            }
        };

    </script>
</body>
</html>
